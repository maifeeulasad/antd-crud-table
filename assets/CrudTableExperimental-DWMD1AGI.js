import{r as I,j as u,B as R}from"./index-ZoKaomao.js";import{s as g,F as O,T as M,f as B,p as F,P as _,a as V,R as A,D as H,b as J,M as P,S as Y,c as W,d as Q,e as G,I as X,g as Z,h as K}from"./CrudTable-F3ZKUo9P.js";const ee=T=>{const{baseUrl:e="",endpoints:y={},headers:k={},transform:r}=T.api,c={list:"/list",create:"/create",update:"/update",delete:"/delete",...y},p=async(f,n={})=>{const w=await fetch(`${e}${f}`,{headers:{"Content-Type":"application/json",...k},...n});if(!w.ok)throw new Error(`HTTP error! status: ${w.status}`);return w.json()};return{getList:async f=>{const n=new URL(`${e}${c.list}`,window.location.origin);Object.entries(f).forEach(([C,S])=>{S!=null&&n.searchParams.append(C,String(S))});const w=await p(n.pathname+n.search);return r!=null&&r.response?r.response(w):w},create:async f=>{const n=r!=null&&r.request?r.request(f):f;return p(c.create,{method:"POST",body:JSON.stringify(n)})},update:async(f,n)=>{const w=r!=null&&r.request?r.request(n):n;return p(`${c.update}/${f}`,{method:"PUT",body:JSON.stringify(w)})},delete:async f=>{await p(`${c.delete}/${f}`,{method:"DELETE"})}}},te=(T,e)=>{let y=[...T],k=Math.max(...y.map(r=>Number(r[e])||0))+1;return{getList:async r=>{const{current:c=1,pageSize:p=10,sortBy:f,sortOrder:n,...w}=r;let C=[...y];Object.entries(w).forEach(([l,m])=>{m!=null&&m!==""&&(C=C.filter(s=>String(s[l]).toLowerCase().includes(String(m).toLowerCase())))}),f&&n&&C.sort((l,m)=>{const s=l[f],h=m[f],b=s>h?1:s<h?-1:0;return n==="ascend"?b:-b});const S=(c-1)*p;return{data:C.slice(S,S+p),total:C.length,success:!0}},create:async r=>{const c={[e]:k++,...r};return y.push(c),c},update:async(r,c)=>{const p=y.findIndex(f=>f[e]===r);if(p===-1)throw new Error("Item not found");return y[p]={...y[p],...c},y[p]},delete:async r=>{const c=y.findIndex(p=>p[e]===r);if(c===-1)throw new Error("Item not found");y.splice(c,1)}}},ae=(T,e)=>{const y=I.useRef(null),[k,r]=I.useState({loading:!1,error:null,data:[],total:0,current:1,pageSize:e.defaultPageSize||10}),c=(()=>{if("operations"in e)return e.operations;if("staticData"in e)return te(e.staticData,T);if("api"in e)return ee(e);throw new Error("useCrudTable: Must provide either staticData, api config, or custom operations")})(),p=I.useCallback(async()=>{var x;r(l=>({...l,loading:!0,error:null}));try{const l={current:k.current,pageSize:k.pageSize},m=await c.getList(l);r(s=>({...s,data:m.data,total:m.total,loading:!1}))}catch(l){const m=l instanceof Error?l.message:"Failed to fetch data";r(s=>({...s,loading:!1,error:m})),(x=e.onError)==null||x.call(e,"fetch",l),g.error(m)}},[k.current,k.pageSize,c,e]),f=I.useCallback(async x=>{var l,m;if(!c.create)return g.error("Create operation not supported"),null;try{r(h=>({...h,loading:!0}));const s=await c.create(x);return e.optimisticUpdates?r(h=>({...h,data:[...h.data,s],total:h.total+1,loading:!1})):await p(),(l=e.onSuccess)==null||l.call(e,"create",s),g.success("Created successfully"),s}catch(s){r(b=>({...b,loading:!1}));const h=s instanceof Error?s.message:"Create failed";return(m=e.onError)==null||m.call(e,"create",s),g.error(h),null}},[c,e,p]),n=I.useCallback(async(x,l)=>{var m,s;if(!c.update)return g.error("Update operation not supported"),null;try{r(b=>({...b,loading:!0}));const h=await c.update(x,l);return e.optimisticUpdates?r(b=>({...b,data:b.data.map(E=>E[T]===x?{...E,...h}:E),loading:!1})):await p(),(m=e.onSuccess)==null||m.call(e,"update",h),g.success("Updated successfully"),h}catch(h){r(E=>({...E,loading:!1}));const b=h instanceof Error?h.message:"Update failed";return(s=e.onError)==null||s.call(e,"update",h),g.error(b),null}},[c,e,T,p]),w=I.useCallback(async x=>{var l,m;if(!c.delete)return g.error("Delete operation not supported"),!1;try{return r(s=>({...s,loading:!0})),await c.delete(x),e.optimisticUpdates?r(s=>({...s,data:s.data.filter(h=>h[T]!==x),total:s.total-1,loading:!1})):await p(),(l=e.onSuccess)==null||l.call(e,"delete",x),g.success("Deleted successfully"),!0}catch(s){r(b=>({...b,loading:!1}));const h=s instanceof Error?s.message:"Delete failed";return(m=e.onError)==null||m.call(e,"delete",s),g.error(h),!1}},[c,e,T,p]),C=I.useCallback(x=>{r(l=>({...l,pageSize:x,current:1}))},[]),S=I.useCallback(x=>{r(l=>({...l,current:x}))},[]);return{refresh:p,create:f,update:n,delete:w,setPageSize:C,setCurrentPage:S,state:k,actionRef:y}},ne=T=>{const{columns:e,rowKey:y,title:k,defaultPageSize:r=10,hookConfig:c,enableBulkOperations:p=!1,customActions:f}=T,n=ae(y,{defaultPageSize:r,...c}),[w,C]=I.useState(!1),[S,x]=I.useState(null),[l,m]=I.useState([]),[s]=O.useForm();I.useEffect(()=>{n.refresh()},[]);const h=e.map(t=>{const a={...t,dataIndex:t.dataIndex,title:t.title,search:t.searchable!==!1};switch(t.fieldType){case"date":return{...a,valueType:"dateTime",render:(d,o)=>{const i=o[t.dataIndex];if(!i)return"-";try{return u.jsx("span",{children:B(F(i),"yyyy-MM-dd HH:mm")})}catch{return u.jsx("span",{children:i})}}};case"enum":return{...a,valueType:"select",valueEnum:t.enumOptions,render:(d,o)=>{var D;const i=o[t.dataIndex],j=(D=t.enumOptions)==null?void 0:D[i];return j?u.jsx(M,{color:j.color,children:j.text}):i}};case"number":return{...a,valueType:"digit",render:(d,o)=>{const i=o[t.dataIndex];return typeof i=="number"?i.toLocaleString():i}};case"boolean":return{...a,valueType:"switch",render:(d,o)=>u.jsx(M,{color:o[t.dataIndex]?"green":"red",children:o[t.dataIndex]?"Yes":"No"})};case"custom":return{...a,render:(d,o)=>{var i;return(i=t.customRender)==null?void 0:i.call(t,o[t.dataIndex],o)}};default:return a}});h.push({title:"Actions",valueType:"option",width:200,render:(t,a)=>{const d=[u.jsx(R,{type:"link",size:"small",onClick:()=>E(a),children:"Edit"},"edit"),u.jsx(R,{type:"link",size:"small",danger:!0,onClick:()=>v(a[y]),children:"Delete"},"delete")],o=(f==null?void 0:f(a,n))||[];return[...d,...o]}});const b=async(t,a,d)=>{try{const o={current:t.current,pageSize:t.pageSize,sortBy:Object.keys(a)[0],sortOrder:Object.values(a)[0],...d,...t},i=n.operations;if(i!=null&&i.getList){const j=await i.getList(o);return{data:j.data,success:!0,total:j.total}}return{data:n.state.data,success:!0,total:n.state.total}}catch{return g.error("Failed to fetch data"),{data:[],success:!1,total:0}}},E=t=>{if(x(t||null),t){const a={...t};e.forEach(d=>{const o=d.dataIndex;if(d.fieldType==="date"&&a[o])try{a[o]=Z(a[o])}catch{}}),s.setFieldsValue(a)}else s.resetFields();C(!0)},$=async()=>{var t;try{const a=await s.validateFields(),d={...a};e.forEach(o=>{var j;const i=o.dataIndex;if(o.fieldType==="date"&&a[i])try{d[i]=K(a[i])}catch{}(j=o.formConfig)!=null&&j.transform&&(d[i]=o.formConfig.transform(a[i]))}),S&&S[y]?await n.update(S[y],d):await n.create(d),C(!1),(t=n.actionRef.current)==null||t.reload()}catch(a){console.error("Form validation failed:",a)}},v=async t=>{P.confirm({title:"Are you sure?",content:"This action cannot be undone.",okText:"Yes, Delete",okType:"danger",cancelText:"Cancel",onOk:async()=>{var d;await n.delete(t)&&((d=n.actionRef.current)==null||d.reload())}})},L=async()=>{if(l.length===0){g.warning("Please select items to delete");return}P.confirm({title:`Delete ${l.length} items?`,content:"This action cannot be undone.",okText:"Yes, Delete All",okType:"danger",cancelText:"Cancel",onOk:async()=>{var a;const t=l.map(d=>n.delete(d));await Promise.allSettled(t),m([]),(a=n.actionRef.current)==null||a.reload()}})},q=p?{selectedRowKeys:l,onChange:m}:void 0;return u.jsxs(_,{needDeps:!0,children:[u.jsx(V,{headerTitle:k,rowKey:y,rowClassName:(t,a)=>a%2===0?"row-differentiator":"",actionRef:n.actionRef,columns:h,request:b,search:{labelWidth:"auto"},pagination:{pageSize:r,showSizeChanger:!0,showQuickJumper:!0},loading:n.state.loading,rowSelection:q,toolBarRender:()=>[u.jsx(R,{type:"primary",icon:u.jsx(A,{}),onClick:()=>E(),children:"New"},"add"),...p&&l.length>0?[u.jsxs(R,{danger:!0,onClick:L,children:["Delete Selected (",l.length,")"]},"bulk-delete")]:[],u.jsx(H,{menu:{items:[{key:"export",label:"Export",disabled:!0},{key:"refresh",label:"Refresh",onClick:()=>n.refresh()}]},children:u.jsx(R,{children:u.jsx(J,{})})},"menu")],options:{setting:{listsHeight:400},reload:()=>n.refresh()},dateFormatter:"string"}),u.jsx(P,{title:S?"Edit Item":"Create Item",open:w,onOk:$,onCancel:()=>C(!1),destroyOnClose:!0,width:600,children:u.jsx(O,{form:s,layout:"vertical",children:e.map(t=>{var j,D,z;if(!t.dataIndex)return null;const a=t.dataIndex,d=t.title,o=!(t.fieldEditable??!0),i=((j=t.formConfig)==null?void 0:j.rules)||((D=t.formConfig)!=null&&D.required?[{required:!0,message:`${d} is required`}]:[]);if((z=t.formConfig)!=null&&z.component)return u.jsx(O.Item,{name:a,label:d,rules:i,children:t.formConfig.component},a);switch(t.fieldType){case"string":return u.jsx(O.Item,{name:a,label:d,rules:i,children:u.jsx(X,{disabled:o})},a);case"number":return u.jsx(O.Item,{name:a,label:d,rules:i,children:u.jsx(G,{style:{width:"100%"},disabled:o})},a);case"date":return u.jsx(O.Item,{name:a,label:d,rules:i,children:u.jsx(Q,{style:{width:"100%"},showTime:!0,disabled:o})},a);case"boolean":return u.jsx(O.Item,{name:a,label:d,valuePropName:"checked",children:u.jsx(W,{disabled:o})},a);case"enum":return u.jsx(O.Item,{name:a,label:d,rules:i,children:u.jsx(Y,{disabled:o,placeholder:`Select ${d.toLowerCase()}`,options:Object.entries(t.enumOptions||{}).map(([U,N])=>({label:N.text,value:U}))})},a);default:return null}})})})]})};export{ne as default};
